<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán Vé</title>
    <link rel="stylesheet" href="/css/show-pay.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <th:block th:replace="~{/common/layout :: head}"></th:block>
</head>
<body>
<th:block th:replace="~{/common/layout :: navbar}"></th:block>
<div class="container main-container">
    <div class="p-5 shadow-lg main-content">
        <h1 class="main-title text-center fw-bold mb-3">Thanh Toán Vé</h1>
        <form action="/vnp" method="POST">
            <!-- One-way display -->
            <div th:if="${tripType} == null">
                <fieldset class="title" th:object="${flight}">
                    <legend class="mb-3">Thông Tin Đặt Chỗ</legend>
                    <input type="hidden" name="flightId" th:value="*{flightId}">
                    <input type="hidden" name="ticketPrice" th:value="*{price}">
                    <p>Số Chuyến: <span th:text="*{flightNumber}"></span></p>
                    <p>Khởi Hành: <span th:text="${#temporals.format(flight.departureTime, 'HH:mm dd-MM-yyyy')}"></span></p>
                    <p>Điểm Đi: <span th:text="*{departureAirport.getCity()}"></span></p>
                    <p>Điểm Đến: <span th:text="*{arrivalAirport.getCity()}"></span></p>
                    <p>Giá vé: <span th:text="${#numbers.formatDecimal(flight.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></span></p>
                </fieldset>
            </div>

            <!-- Roundtrip display -->
            <div th:if="${tripType} == 'roundtrip'">
                <div class="row g-4">
                    <div class="col-md-6">
                        <fieldset class="title" th:object="${outboundFlight}">
                            <legend class="mb-3">Chiều đi</legend>
                            <input type="hidden" name="outboundFlightId" th:value="*{flightId}">
                            <p>Số Chuyến: <span th:text="*{flightNumber}"></span></p>
                            <p>Khởi Hành: <span th:text="${#temporals.format(outboundFlight.departureTime, 'HH:mm dd-MM-yyyy')}"></span></p>
                            <p>Điểm Đi: <span th:text="*{departureAirport.getCity()}"></span></p>
                            <p>Điểm Đến: <span th:text="*{arrivalAirport.getCity()}"></span></p>
                            <p>Giá vé: <span th:text="${#numbers.formatDecimal(outboundFlight.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></span></p>
                            <div class="seats-list">
                                <p>Ghế đã chọn:</p>
                                <ul>
                                    <li th:each="seat : ${outboundSeats}" th:text="${seat.seatNumber}"></li>
                                </ul>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-md-6">
                        <fieldset class="title" th:object="${returnFlight}">
                            <legend class="mb-3">Chiều về</legend>
                            <input type="hidden" name="returnFlightId" th:value="*{flightId}">
                            <p>Số Chuyến: <span th:text="*{flightNumber}"></span></p>
                            <p>Khởi Hành: <span th:text="${#temporals.format(returnFlight.departureTime, 'HH:mm dd-MM-yyyy')}"></span></p>
                            <p>Điểm Đi: <span th:text="*{departureAirport.getCity()}"></span></p>
                            <p>Điểm Đến: <span th:text="*{arrivalAirport.getCity()}"></span></p>
                            <p>Giá vé: <span th:text="${#numbers.formatDecimal(returnFlight.price, 0, 'COMMA', 0, 'POINT')} + '₫'"></span></p>
                            <div class="seats-list">
                                <p>Ghế đã chọn:</p>
                                <ul>
                                    <li th:each="seat : ${returnSeats}" th:text="${seat.seatNumber}"></li>
                                </ul>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <h5>Tổng cộng: <span th:text="${#numbers.formatDecimal(grandTotal, 0, 'COMMA', 0, 'POINT')} + '₫'"></span></h5>
                </div>
                <!-- Passenger information for roundtrip -->
                <div class="row mt-4">
                    <fieldset class="col-md-12" th:each="seat, status : ${outboundSeats}"
                              th:classappend="${outboundSeats.size() > 1 ? 'col-lg-6' : 'col-lg-12'}"
                              th:object="${bookingWrapper}">
                              <legend th:text="'Khách hàng ghế ' + ${seat.seatNumber} + ' (Chiều đi)'"></legend>

                        <input class="mb-3 form-control" type="hidden"
                               th:name="'customers[' + ${status.index} + '].numberOfSeats'"
                               th:value="${seat.seatNumber}"/>

                        <label th:for="'fullName_rt_' + ${status.index}">Họ Tên:</label>
                        <input class="mb-3 form-control" type="text" th:id="'fullName_rt_' + ${status.index}"
                               th:name="'customers[' + ${status.index} + '].name'" required>

                        <label th:for="'dob_rt_' + ${status.index}">Ngày Sinh:</label>
                        <input class="mb-3 dob form-control" type="date" th:id="'dob_rt_' + ${status.index}"
                               th:name="'customers[' + ${status.index} + '].dob'" required>

                        <label th:for="'gender_rt_' + ${status.index}">Giới tính:</label>
                        <select class="mb-3 form-select" th:id="'gender_rt_' + ${status.index}"
                                th:name="'customers[' + ${status.index} + '].gender'" required>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Giới tính thứ 3">Giới tính thứ 3</option>
                        </select>

                        <label th:for="'country_rt_' + ${status.index}">Quốc Gia:</label>
                        <input class="mb-3 form-control" type="text" th:id="'country_rt_' + ${status.index}"
                               th:name="'customers[' + ${status.index} + '].country'" required>

                        <p>Số ghế (chiều đi): <span class="title" th:text="${seat.seatNumber}"></span></p>
                    </fieldset>
                </div>
                <div class="row mt-2">
                    <fieldset class="col-md-12" th:each="seat, status : ${returnSeats}"
                              th:classappend="${returnSeats.size() > 1 ? 'col-lg-6' : 'col-lg-12'}"
                              th:object="${bookingWrapper}">
                              <legend th:text="'Khách hàng ghế ' + ${seat.seatNumber} + ' (Chiều về)'"></legend>

                        <input class="mb-3 form-control" type="hidden"
                               th:name="${'customers[' + (status.index + #lists.size(outboundSeats)) + '].numberOfSeats'}"
                               th:value="${seat.seatNumber}"/>

                        <label th:for="${'fullName_rt2_' + (status.index + #lists.size(outboundSeats))}">Họ Tên:</label>
                        <input class="mb-3 form-control" type="text"
                               th:id="${'fullName_rt2_' + (status.index + #lists.size(outboundSeats))}"
                               th:name="${'customers[' + (status.index + #lists.size(outboundSeats)) + '].name'}" required>

                        <label th:for="${'dob_rt2_' + (status.index + #lists.size(outboundSeats))}">Ngày Sinh:</label>
                        <input class="mb-3 dob form-control" type="date"
                               th:id="${'dob_rt2_' + (status.index + #lists.size(outboundSeats))}"
                               th:name="${'customers[' + (status.index + #lists.size(outboundSeats)) + '].dob'}" required>

                        <label th:for="${'gender_rt2_' + (status.index + #lists.size(outboundSeats))}">Giới tính:</label>
                        <select class="mb-3 form-select"
                                th:id="${'gender_rt2_' + (status.index + #lists.size(outboundSeats))}"
                                th:name="${'customers[' + (status.index + #lists.size(outboundSeats)) + '].gender'}" required>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Giới tính thứ 3">Giới tính thứ 3</option>
                        </select>

                        <label th:for="${'country_rt2_' + (status.index + #lists.size(outboundSeats))}">Quốc Gia:</label>
                        <input class="mb-3 form-control" type="text"
                               th:id="${'country_rt2_' + (status.index + #lists.size(outboundSeats))}"
                               th:name="${'customers[' + (status.index + #lists.size(outboundSeats)) + '].country'}" required>

                        <p>Số ghế (chiều về): <span class="title" th:text="${seat.seatNumber}"></span></p>
                    </fieldset>
                </div>
                <!-- Hidden fields for VNP expects ticketPrice and flightId; use return flight id for reference and perPassengerPrice -->
                <input type="hidden" name="ticketPrice" th:value="${perPassengerPrice}">
                <input type="hidden" name="flightId" th:value="${returnFlight.flightId}">
            </div>

            <!-- Thông tin khách hàng -->
            <div class="row" th:if="${tripType} == null">
                <fieldset class="col-md-12" th:each="seat, status : ${seats}" th:classappend="${seats.size() > 1 ? 'col-lg-6' : 'col-lg-12'}" th:object="${bookingWrapper}">
                    <legend>Thông Tin Khách Hàng <span th:text="${status.count}"></span></legend>

                    <input class="mb-3 form-control" type="hidden" th:name="'customers[' + ${status.count} + '].numberOfSeats'"
                           th:value="${seat.seatNumber}"/>

                    <label th:for="'fullName_' + ${status.count}">Họ Tên:</label>
                    <input class="mb-3 form-control" type="text" th:id="'fullName_' + ${status.count}"
                           th:name="'customers[' + ${status.count} + '].name'" required>

                    <label th:for="'dob_' + ${status.count}">Ngày Sinh:</label>
                    <input class="mb-3 dob form-control" type="date" th:id="'dob_' + ${status.count}"
                           th:name="'customers[' + ${status.count} + '].dob'" required>

                    <label th:for="'gender_' + ${status.count}">Giới tính:</label>
                    <select class="mb-3 form-select" type="text" th:id="'gender_' + ${status.count}"
                            th:name="'customers[' + ${status.count} + '].gender'" required>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Giới tính thứ 3">Giới tính thứ 3</option>
                    </select>

                    <label th:for="'country_' + ${status.count}">Quốc Gia:</label>
                    <input class="mb-3 form-control" type="text" th:id="'country_' + ${status.count}"
                           th:name="'customers[' + ${status.count} + '].country'" required>

                    <p>Số ghế: <span class="title" th:text="${seat.seatNumber}"></span></p>
                </fieldset>
            </div>

            <!-- Thông tin liên hệ -->
            <fieldset>
                <legend class="mb-3">Thông Tin Liên Hệ</legend>
                <label for="phone">Số Điện Thoại:</label>
                <input class="mb-3 form-control" type="tel" id="phone" name="phone" required>
                <label for="address">Địa Chỉ:</label>
                <input class="form-control" type="text" id="address" name="address" required>
            </fieldset>
            <div class="d-flex justify-content-center">
                <a th:if="${tripType} == null" th:href="@{/flights/{id}/seats(id=${flight.flightId})}" class="btn btn-secondary mt-5 w-25 me-4">Trở Lại</a>
                <button type="submit" class="btn btn-primary mt-5 w-25">Thanh Toán</button>
            </div>


        </form>
    </div>

</div>
<script>
    flatpickr(".dob", {
        dateFormat: 'd-m-Y',
        maxDate: 'today'
    });
</script>
<th:block th:replace="~{/common/layout :: footer}"></th:block>

</body>
</html>